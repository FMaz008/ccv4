<script type="text/javascript">
//<!--
	var arrLieux = Array();
	gosearch = function (type)
	{
                $.ajax({
                    url:'?mj=Search&popup=1',
                    method: 'post',
                    data: 'searchWhat=Lieu_Sendmsg&search='+$("#lieu_search").val(), 
                    dataType: "html",
                    success: function (data) {
                        gosearch_confirm(data);
                    }
                });
	}
	
	gosearch_confirm = function (rval)
	{
		$("#lieu_results").html(rval);
	}
	
	
	//Cette fonction est apellé automatiquement lors d'un click sur un résultat de la recherche AJAX
	lieuSelect = function (id, ntech, nom)
	{
		addLieu(id, ntech);
	}
	
	
	
	
	//Ajouter un lieu au tableau des lieux
	addLieu = function (id, nom)
	{
		if(searchLieu(id)===false)
		{
			arrLieux.push(id);
			
			$("#listLieux").append(
                            "<div id='lieux_" + id + "'>"
                                + nom + " "
                                + "<span class='fakelink' style='font-size:10px;' onclick='remLieu("+id+");return false;'>"
                                    + "(Supprimer)"
                                + "</span>\n"
                            + "</div>"
                        );
			
			//Mettre a jour le champs dans le formulaire
			setUrlLieux();
		}
	}
	
	//Supprimer un lieu
	remLieu = function (id)
	{
		//Rechercher si l'ID existe déjà
		var i = searchLieu(id);
		if(i !== false)
		{
			//Supprimer l'entré du tableau
			arrLieux.splice(i,1);
			
			//Supprimée l'entrée visible
			$("#lieux_" + id).remove();
			
			//Mettre a jour le champs dans le formulaire
			setUrlLieux();
		}
	}

	//Rechercher si un lieu est présent
	searchLieu = function (id)
	{
		for(var i=0; i<arrLieux.length; i++)
			if(arrLieux[i] == id)
				return i;
		return false;
	}
	
	//Retourner un string URL de la liste des lieux
	setUrlLieux = function()
	{
		var val;
		for(var i=0; i<arrLieux.length; i++)
			if(i===0)
				val = arrLieux[i];
			else
				val += "," + arrLieux[i];
		$('#arrLieux').val(val);
	}
	
	
//-->	
</script>

<?php if(isset($STATUS_MSG)){ echo $STATUS_MSG; } ?>



<table class="center">
	<tr>
		<td class="title" colspan="2">Envoyer un message à un ou plusieurs lieux</td>
	</tr>
	<tr>
		<td class="value" style="vertical-align:top;">
			<form method="post" id="Lieu_Sendmsg" onsubmit="gosearch(this.id);return false;">
				N. tech.: <input type="text" class="text" id="lieu_search" name="search" style="width:100px;" />
						<input type="submit" class="button" name="go" value="Go" style="width:25px;" />
	
				<div id="lieu_results" style="height:30em;overflow:auto;"></div>
			</form>
		</td>
		<td class="value">
		<form method="post" action="?mj=Lieu_Sendmsg">
			<input type="hidden" id="arrLieux" name="arrLieux" value="" />
			<table>
			<tr>
				<td class="value">
					À: <div id="listLieux" style="height:7em;overflow:auto;"></div>
					<br />
					De <input type="text" class="text" name="from" value="<?php echo $MJ_NOM;?>" /><br />
					<textarea name="msg" style="width:400px;height:200px;"></textarea>
				</td>
			</tr><tr>
				<td class="send">
					<input class="button" type="submit" name="send" value="Envoyer le message" />
				</td>
			</tr>
			</table>
		</form>
	</tr>
</table>

